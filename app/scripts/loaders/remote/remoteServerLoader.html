<link rel="import" href="./expandedLoader.html">

<script>
  const GITHUB_CLIENT_ID = "086085200026d5c54c19";
  const GITHUB_CLIENT_SECRET = "f40981be76b00e35d4437d71184f42a70d08f3a6";

  // eslint-disable-next-line no-unused-vars
  class RemoteServerLoader extends ExpandedLoader {
    constructor(projectType, remote, getContext, initialPath) {
      super();
      console.log('Using remote server loader');
      this.loader = this._getProjectLoader(projectType);
      this.remote = remote || getParameterByName('remote');
      this.uri = this.remote.substr(0, this.remote.lastIndexOf('/')+1);
      this.project = this.remote.substr(this.remote.lastIndexOf('/')+1, this.remote.length);
      this.initialPath = initialPath || getParameterByName('path');
    }

    static reportIssue(title, body) {
      return $.ajax({
        type: "POST",
        url: "https://api.github.com/repos/gobstones/gobstones-issues/issues",
        data: JSON.stringify({ title, body }),
        dataType: "json",
        headers: {
          "Authorization": `token ${atob("M2ZiMGJkNWM0YzVjZGJkY2FlMTIwOTgzNmRjNTI5M2EwYTdmZGU2Yw==")}`
        }
      });
    }

    static getDesktopRelease() {
      return $.get(
        "https://api.github.com/repos/gobstones/gobstones-web-desktop/releases/latest?client_id=${GITHUB_CLIENT_ID}&client_secret=${GITHUB_CLIENT_SECRET}"
      )
    }

    load(getContext, callback) {
      return this.loadDir(this.initialPath).then(files => {
        if (this.initialPath !== undefined) {
          console.log(this.initialPath);
          files.forEach(it => {
            it.relativePath = it.relativePath.replaceAll(`/${this.initialPath}/`, "")
          });
        }
        this.loader.readRaw(getContext(), this.createZip(files), callback);
      });
    }

    loadDir(path = "") {
      return this.scanDir(path).then(response => {
        const $files = response.items.map(it =>
          this._loadEntry(it, path)
        );

        return $.when.apply($, $files).then(function() {
          return _(arguments).toArray().flatten().value();
        });
      });
    }

    scanDir(path = this.initialPath || "") {
      return $.get(
        `${this.remote}/${path}`
      );
    }

    _loadEntry(entry, path) {
      return entry.dir
        ? this.loadDir(`${path}/${entry.name}`)
        : this._downloadFile(entry);
    }

    _downloadFile(entry) {
      return $.getBinary(`${this.remote}/${entry.relativePath}`).then(content => {
        return { relativePath: entry.relativePath.replaceAll(encodeURI(this.initialPath + '/'), ''), content };
      });
    }
  }
</script>

