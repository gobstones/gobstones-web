<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../scripts/simplemde.html">
<link rel="import" href="../../scripts/stylist.html">
<link rel="import" href="../../scripts/loaders/components/metadataLoader.html">
<link rel="import" href="../../scripts/behaviors/busListenerBehavior.html">
<link rel="import" href="../../scripts/behaviors/permissionsBehavior.html">
<link rel="import" href="../../scripts/behaviors/localizationBehavior.html">
<link rel="import" href="../../scripts/behaviors/loaderBehavior.html">

<dom-module id="metadata-editor">
  <template>
    <style>
      .menu-header-gobstones {
        background-color: white;
        font-weight: 800;
      }

      .metadata-editor-options {
        width: 100%;
        overflow: scroll;
        overflow-x: hidden;
      }

      .json-editor {
        height: 50vh;
      }

      .gray {
        color: gray;
      }
    </style>

    <div class="metadata-editor-options">
      <paper-item center-justified flex class="menu-header-gobstones">
        <div>[[localize("settings-code")]]</div>
      </paper-item>

      <paper-item>
        <paper-item-body>
          <div>[[localize("settings-code-visible")]]</div>
        </paper-item-body>
        <paper-toggle-button checked="{{metadata.source.visible}}"></paper-toggle-button>
      </paper-item>

      <paper-item>
        <paper-item-body>
          <div>[[localize("settings-code-autoopen-description")]]</div>
        </paper-item-body>
        <paper-toggle-button checked="{{metadata.initialDescription}}"></paper-toggle-button>
      </paper-item>

      <paper-item>
        <paper-item-body>
          <div>[[localize("settings-code-link")]]</div>
        </paper-item-body>
        <paper-input value="{{metadata.link}}"></paper-input>
      </paper-item>

      <paper-item center-justified flex class="menu-header-gobstones">
        <div>[[localize("settings-boards")]]</div>
      </paper-item>

      <paper-item>
        <paper-item-body>
          <div>[[localize("settings-boards-visible-edition")]]</div>
        </paper-item-body>
        <paper-toggle-button on-tap="_onBoardVisibleEditionChanged" checked="{{metadata.board.visible_edition}}"></paper-toggle-button>
      </paper-item>

      <paper-item disabled$="{{boardEditionOptionsDisabled}}">
        <paper-item-body>
          <div>[[localize("settings-boards-collapse-toolbox")]]</div>
        </paper-item-body>
        <paper-toggle-button checked="{{metadata.board.collapse_toolbox}}"></paper-toggle-button>
      </paper-item>

      <paper-item disabled$="{{boardEditionOptionsDisabled}}">
        <paper-item-body>
          <div>[[localize("settings-boards-can-change-initial-board")]]</div>
        </paper-item-body>
        <paper-toggle-button checked="{{metadata.board.user_permissions.can_change_initial_board}}"></paper-toggle-button>
      </paper-item>

      <paper-item disabled$="{{boardEditionOptionsDisabled}}">
        <paper-item-body>
          <div>[[localize("settings-boards-can-view-size-section")]]</div>
        </paper-item-body>
        <paper-toggle-button checked="{{metadata.board.user_permissions.can_view_size_section}}"></paper-toggle-button>
      </paper-item>

      <paper-item>
        <paper-item-body>
          <div>[[localize("settings-boards-can-edit-board")]]</div>
        </paper-item-body>
        <paper-toggle-button checked="{{metadata.board.user_permissions.can_edit_board}}"></paper-toggle-button>
      </paper-item>

      <paper-item center-justified flex class="menu-header-gobstones">
        <div>[[localize("settings-attires")]]</div>
      </paper-item>

      <paper-item>
        <paper-item-body>
          <div>[[localize("settings-attires-visible")]]</div>
        </paper-item-body>
        <paper-toggle-button checked="{{metadata.attire.visible}}"></paper-toggle-button>
      </paper-item>

      <paper-item disabled$="{{boardEditionOptionsDisabled}}">
        <paper-item-body>
          <div>[[localize("settings-boards-can-view-attire-section")]]</div>
        </paper-item-body>
        <paper-toggle-button on-tap="_onAttireSectionVisibleChanged" checked="{{metadata.board.user_permissions.can_view_attire_section}}"></paper-toggle-button>
      </paper-item>

      <paper-item disabled$="[[_either(boardEditionOptionsDisabled, attireSectionDisabled)]]">
        <paper-item-body>
          <div>[[localize("settings-attires-can-toggle-visibility")]]</div>
        </paper-item-body>
        <paper-toggle-button checked="{{metadata.attire.user_permissions.can_toggle_visibility}}"></paper-toggle-button>
      </paper-item>

      <paper-item center-justified flex class="menu-header-gobstones">
        <div>[[localize("settings-execution")]]</div>
      </paper-item>

      <paper-item>
        <paper-item-body>
          <div>[[localize("settings-boards-can-change-initial-board-source")]]</div>
        </paper-item-body>
        <paper-toggle-button checked="{{metadata.board.user_permissions.can_change_initial_board_source}}"></paper-toggle-button>
      </paper-item>

      <paper-item>
        <paper-item-body>
          <div>[[localize("settings-execution-speed-can-change-speed")]]</div>
        </paper-item-body>
        <paper-toggle-button checked="{{metadata.execution_speed.user_permissions.can_change_speed}}"></paper-toggle-button>
      </paper-item>

      <paper-item center-justified flex class="menu-header-gobstones">
        <paper-item-body>
          <div>[[localize("settings-cover")]]</div>
        </paper-item-body>
        <paper-icon-button on-click="loadImage" icon="icons:folder-open" alt="open"> </paper-icon-button>
        <template is="dom-if" if="{{cover}}">
          <img src="{{cover}}" width="30" height="30" />
        </template>
      </paper-item>
      <input id="image" type="file" accept=".png" on-change="onLoadedImage" style="visibility: hidden;" />

      <paper-item center-justified flex class="menu-header-gobstones">
        <div>[[localize("settings-blocks")]]</div>
      </paper-item>

      <!-- Al pasarlo entre corchetes dobles, la expresión se vuelve a evaluar cuando cambia la metadata -->
      <blocks-toolbox-selector default-toolbox="{{defaultToolbox}}" blocks="[[metadata.blocks]]"></blocks-toolbox-selector>
    </div>
  </template>

  <script>
    Polymer({
      is: 'metadata-editor',
      properties: {
        metadata: {
          type: Object,
          value: { }
        },
        defaultToolbox: String,
        cover: {
          type: String,
          value: null
        },
        previewChanges: {
          type: Boolean,
          value: false
        },
        boardEditionOptionsDisabled: {
          type: Boolean,
          value: false
        },
        attireSectionDisabled: {
          type: Boolean,
          value: false
        }
      },
      /* @faloi:
      Agregué este listener para que el blocks-toolbox-selector avise cuando cambian los
      bloques seleccionados.
      Ver https://polymer-library.polymer-project.org/1.0/docs/devguide/events#event-listeners
      */
      listeners: {
        'teacher-selected-blocks-changed': '_onSelectedBlocksChanged',
      },
      behaviors: [
        Polymer.BusListenerBehavior,
        Polymer.PermissionsBehavior,
        Polymer.LocalizationBehavior,
        Polymer.LoaderBehavior
      ],
      observers: [
        "_onMetadataChanged(metadata.*)",
      ],

      attached: function() {
        /* @faloi:
        No encontré forma polymerosa de suscribirme a un evento de un nodo "hermano",
        así que lo resolví así.
        */
        document
          .querySelector('code-runner')
          .addEventListener('teacher-preview-configuration-changed', (event) => {
            this._onPreviewChangesChanged(event);
          });
      },

      ready: function() {
        this.set("metadata", this._defaultMetadata());

        this.stylist = new Stylist();
        this.stylist.setUpMetadataEditorCustomizations();
      },

      getMetadata: function() {
        return this.metadata;
      },

      setMetadata: function(config) {
        this.set("metadata", config);
      },

      reset: function() {
        this.setMetadata(this._defaultMetadata());
        this.defaultToolbox = "";
        this.previewChanges = false;
        this.cover = null;
      },

      grayedUnless: function({ base }, property) {
        return !_.get(base, property) ? "gray" : "";
      },

      loadImage: function(e) {
        $(this.$.image).click()
      },

      onLoadedImage: function(event) {
        const file = _.first(event.target.files);

        const fileReader = new FileReader();
        fileReader.onload = (event) => {
          const base64 = event.target.result;
          this.set("cover", base64);
        };
        fileReader.readAsDataURL(file);

        event.target.value = null;
      },

      // @faloi: no se puede poner un || en el binding, por eso creé esta función
      _either: function(x, y) {
        return x || y;
      },

      _onBoardVisibleEditionChanged: function () {
        const boardVisibleEdition = this.metadata.board.visible_edition;
        this.boardEditionOptionsDisabled = !boardVisibleEdition;
        this.setMetadata(_.merge({}, this.metadata, {
          board: {
            collapse_toolbox: false,
            user_permissions: {
              can_change_initial_board: boardVisibleEdition,
              can_view_size_section: boardVisibleEdition,
              can_view_attire_section: boardVisibleEdition,
              can_toggle_visibility: boardVisibleEdition
            }
          },
          attire: {
            user_permissions: {
              can_toggle_visibility: boardVisibleEdition
            }
          }
        }));
      },

      _onAttireSectionVisibleChanged: function () {
        const attireSectionVisible = this.metadata.board.user_permissions.can_view_attire_section;
        this.attireSectionDisabled = !attireSectionVisible;
        this.setMetadata(_.merge({}, this.metadata, {
          attire: {
            user_permissions: {
              can_toggle_visibility: attireSectionVisible
            }
          }
        }));
      },

      _onSelectedBlocksChanged: function({ detail: newBlocks }) {
        this.metadata.blocks = newBlocks;
        this._refreshPreviewIfEnabled(this.metadata);
      },

      _onMetadataChanged: function({ base }) {
        this.defaultToolbox = base.blocks && base.blocks.defaultToolbox;
        this.notifyPath('metadata.blocks');
        this._refreshPreviewIfEnabled(base);
      },

      _refreshPreviewIfEnabled(metadata) {
        if (this.previewChanges) {
          this._previewChanges(metadata);
        }
      },

      _onPreviewChangesChanged({ detail: previewChanges }) {
        try {
          /* @faloi:
          Es redundante mantener este estado local,
          pero no sé cómo manejar estado global sin pasearlo por todos los componentes.
          */
          this.previewChanges = previewChanges;
          if (previewChanges) this._previewChanges(this.metadata);
          else this._resetPreview();
        } catch(e) {}
      },

      _previewChanges(metadata) {
        new MetadataLoader().readSecondaryOptions(this._context(), metadata);
      },

      _resetPreview() {
        new MetadataLoader().resetSecondaryOptions(this._context());
      },

      _defaultMetadata() {
        return {
          library: {
            visible: false
          },
          source: {
            visible: true,
            percentage: 0.6,
          },
          board: {
            visible_edition: true,
            collapse_toolbox: false,
            user_permissions: {
              can_change_initial_board: true,
              can_change_initial_board_source: true,
              can_edit_board: true,
              can_view_size_section: true,
              can_view_attire_section: true
            }
          },
          execution_speed: {
            user_permissions: {
              can_change_speed: true
            }
          },
          attire: {
            user_permissions: {
              can_toggle_visibility: true
            }
          },
          initialDescription: true,
          link: "",
          blocks: {
            visible: [],
            disabled: []
          }
        };
      }
    });
  </script>
</dom-module>


